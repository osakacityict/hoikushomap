<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    
    <!-- Safari と Edge での自動電話番号リンクを無効にする -->
    <meta name="format-detection" content="telephone=no">
    
    <title>サンプル市 保育施設等 空き情報マップ</title>
    <link rel="stylesheet" type="text/css" href="css/uikit.min.css" />
    <link rel="stylesheet" type="text/css" href="css/theme.css?version=0.0.61" />

</head>
<body>

    <!-- dialog:ページ訪問時 -->
    <div id="dialog-readme" uk-modal>
        <div class="uk-modal-dialog">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <div class="uk-modal-header tm-dialog-header">
                <div class="uk-background-cover uk-height-small uk-panel uk-flex uk-flex-center uk-flex-middle tm-dialog-title">
                    <h2 id="dialog-readme-title" class="uk-h4">
                    </h2>
                </div>
            </div>
            <div id="dialog-readme-body" class="uk-modal-body" uk-overflow-auto>
            </div>
            <div class="uk-modal-footer uk-text-right">
                <button class="uk-button uk-button-primary uk-modal-close" type="button" onclick="getPOSfromGPS();">現在地を表示</button>
                <button class="uk-button uk-button-default uk-modal-close" type="button">閉じる</button>
            </div>
        </div>
    </div>
    
    <!-- dialog:「詳細をLINEにメモ」タップ時 -->
    <div id="dialog-sendtoline" uk-modal>
        <div class="uk-modal-dialog uk-margin-auto-vertical">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <div class="uk-modal-body">
                <p>選択した施設を、LINEのトーク画面に保存しました。</p>
                <p>続けて他の施設を探しますか？</p>
            </div>
            <div class="uk-modal-footer uk-text-right">
                <button class="uk-button uk-button-primary uk-modal-close" type="button">続けて探す</button>
                <button class="uk-button uk-button-default" type="button" onclick="liff.closeWindow();">LINEに戻る</button>
            </div>
        </div>
    </div>
    
    <!-- dialog:error -->
    <div id="dialog-error" uk-modal>
        <div class="uk-modal-dialog uk-margin-auto-vertical">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <div id="dialog-error-title" class="uk-modal-header"></div>
            <div id="dialog-error-body" class="uk-modal-body"></div>
            <div class="uk-modal-footer uk-text-right">
                <button class="uk-button uk-button-default uk-modal-close" type="button">閉じる</button>
            </div>
        </div>
    </div>

    <!-- alert -->
    <div id="alert" class="show-special-only hidden">
        <div id="alert-wrapper" class="uk-alert-danger" uk-alert>
            <a id="alert-close" class="uk-alert-close" href="#" uk-close></a>
            <div id="alert-body">
            </div>
        </div>
    </div>

    <!-- map -->
    <div id="map-canvas">
    </div>

    <!-- menu -->
    <form id="menu-top" class="tm-menu tm-menu-top">

        <div>
            <a href="#" class="uk-button uk-button-default" onclick="getPOSfromGPS();">現在地</a>
        </div>

        <div>
            <label class="uk-form-label" for="menu-query1" hidden>距離</label>
            <div class="uk-form-controls">
                <select class="uk-select" id="menu-query1" name="menu-query1">
                    <option value="500">500m</option>
                    <option value="1000" selected>1km</option>
                    <option value="2000">2km</option>
                </select>
            </div>
        </div>
        
    </form>

    <form id="menu-bottom" class="tm-menu tm-menu-bottom">

        <div class="show-special-only hidden">
            <div class="uk-form-controls">
                <select class="uk-select" id="target" name="target">
                    <option class="dataname-monthly" value="0"></option>
                    <option class="dataname-special" value="1-2"></option>
                </select>
            </div>
        </div>

        <div>
            <label class="uk-form-label" for="menu-query2" hidden>クラス年齢</label>
            <div class="uk-form-controls">
                <div id="menu-query2" class="tm-menu-checkbox">
                    <label><input class="uk-checkbox" type="checkbox" name="menu-query2" value="100000"> 0歳</label>
                    <label><input class="uk-checkbox" type="checkbox" name="menu-query2" value="10000"> 1歳</label>
                    <label class="tm-menu-checkbox-noborder-right"><input class="uk-checkbox" type="checkbox" name="menu-query2" value="1000"> 2歳</label><br>
                    <label class="tm-menu-checkbox-noborder-bottom"><input class="uk-checkbox" type="checkbox" name="menu-query2" value="100"> 3歳</label>
                    <label class="tm-menu-checkbox-noborder-bottom"><input class="uk-checkbox" type="checkbox" name="menu-query2" value="10"> 4歳</label>
                    <label class="tm-menu-checkbox-noborder-right tm-menu-checkbox-noborder-bottom"><input class="uk-checkbox" type="checkbox" name="menu-query2" value="1"> 5歳</label>
                </div>
            </div>
        </div>
        
    </form>

    <!-- scripts -->
    <script src="js/uikit.min.js"></script>
    <script src="js/uikit-icons.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery.csv-1.0.3.min.js"></script>
    <script src="js/datetime.js?version=0.0.3"></script>
    <script src="js/form.js?version=0.0.1"></script>
    <script type="text/javascript">

        // debug
        function isDebug() {
            return (location.hostname != "www.city.sample.lg.jp")              
        }
        
        // LIFF ID
        function getLiffId() {
            var liffId = {
                default: "9999999999-99999999",
                debug:   "9999999999-99999999"
            };
            if (isDebug()) {
                return liffId.debug;
            } else {
                return liffId.default;
            }
        }

        // Lineブラウザの場合のみ、LIFFのライブラリをインポート
        var ua = window.navigator.userAgent;
        if (ua.indexOf('Line/') != -1) { 
            $("head").append('<script id="liff-sdk" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" />');
        }
        
        // LIFFのライブラリがインポートされている場合はTrueを返す
        function isExistsLiffSdk() {
            return (document.getElementById('liff-sdk') != null);
        }
        
        // Lineへメッセージ送信
        var uriQueryOpenByBrowser = "openExternalBrowser=1";
        var baseUriGoogle = "https://www.google.com/search?q=";
        var baseUriGoogleKeiro = "https://www.google.com/maps?q={address}";
        function getUriForGoogleSearch(param) {
            return encodeURI(baseUriGoogle + param + "&" + uriQueryOpenByBrowser);
        }
        function getUriForGoogleKeiro(param) {
            return encodeURI(baseUriGoogleKeiro.replace("{address}", param) + "&" + uriQueryOpenByBrowser);
        }
        function sendMessage(name, add, tel, description) {
            
            // LIFF存在確認
            if (!isExistsLiffSdk()) {
                // alert("この機能はLineブラウザからのみ利用できます。" + "\n\n" + ua);
                showErrorDialog("この機能はLINEブラウザからのみ利用できます。", "LIFFエラー");
                return;
            }

            name = name.replace("\n", "");
            add = add.replace("\n", "");
            tel = tel.replace("\n", "");
            description = description.replace("\n", "");

            var uriTitle = getUriForGoogleSearch(name);
            var uriKeiro = getUriForGoogleKeiro(add);

            msg = {
                "type": "flex",
                "altText": "保育施設等：" + name,
                "contents": {
                    "type": "bubble",
                    "styles": {
                        "footer": {
                            "separator": true
                        }
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": "HOIKU SHISETSU",
                                "weight": "bold",
                                "color": "#f74e8f",
                                "size": "sm"
                            },
                            {
                                "type": "text",
                                "text": name,
                                "weight": "bold",
                                "size": "xxl",
                                "margin": "md",
                                "action": {
                                    "type": "uri",
                                    "label": name,
                                    "uri": uriTitle
                                }
                            },
                            {
                                "type": "text",
                                "text": add,
                                "size": "xs",
                                "color": "#aaaaaa",
                                "wrap": true
                            },
                            {
                                "type": "text",
                                "text": description,
                                "size": "sm",
                                "color": "#888888",
                                "flex": 0,
                                "wrap": true,
                                "margin": "md"
                            },
                            {
                                "type": "separator",
                                "margin": "xxl"
                            },
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "margin": "xxl",
                                "action": {
                                    "type": "uri",
                                    "label": "自宅からの経路を調べる",
                                    "uri": uriKeiro
                                },
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "自宅からの経路を調べる",
                                        "size": "sm",
                                        "color": "#555555",
                                        "flex": 0,
                                        "wrap": true
                                    },
                                    {
                                        "type": "text",
                                        "text": ">　",
                                        "size": "sm",
                                        "color": "#dddddd",
                                        "align": "end"
                                    }
                                ]
                            },
                            {
                                "type": "separator",
                                "margin": "xxl"
                            },
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "margin": "xxl",
                                "action": {
                                    "type": "uri",
                                    "label": tel + "へ電話する",
                                    "uri": "tel:" + tel
                                },
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": tel + "へ電話する",
                                        "size": "sm",
                                        "color": "#555555",
                                        "flex": 0,
                                        "wrap": true
                                    },
                                    {
                                        "type": "text",
                                        "text": ">　",
                                        "size": "sm",
                                        "color": "#dddddd",
                                        "align": "end"
                                    }
                                ]
                            },
                            {
                                "type": "separator",
                                "margin": "xxl"
                            },
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "margin": "xxl",
                                "action": {
                                    "type": "uri",
                                    "label": "他の施設を探す",
                                    "uri": "line://app/9999999999-99999999"
                                },
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "他の施設を探す",
                                        "size": "sm",
                                        "color": "#555555",
                                        "flex": 0,
                                        "wrap": true
                                    },
                                    {
                                        "type": "text",
                                        "text": ">　",
                                        "size": "sm",
                                        "color": "#dddddd",
                                        "align": "end"
                                    }
                                ]
                            }
                        ]
                    }
                }
            };

            // メッセージを送信
            liff.sendMessages([msg])
            .then(function() {
                // liff.closeWindow();
                UIkit.modal("#dialog-sendtoline").show();
            })
            .catch(function(err) {
                alert(err);
            });
        }

        // クライアントがスマートフォンの場合にTrueを返す
        function isSmartPhone() {
            if (navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/i)) {
            	return true;
            } else {
                return false;
            }
        }

        // settings
        var settings = {

            // 基準日
            baseDate: {
                special: {
                    startDate: "",
                    endDate: ""
                },
                monthly: ""
            },

            // 入所月
            targetMonth: {
                special: "",
                monthly: ""
            },

            // データ名称
            dataName: {
                special: function() {return settings.targetMonth.special + "月入所(2次調整)";}, 
                monthly: function() {return settings.targetMonth.monthly + "月入所";}
            },

            // 二次調整CSV公開中に表示させるアラート
            alert: {

                // 二次調整データ表示中のアラートメッセージ
                special: function() {
                    var res = 
                        '<p>' + settings.dataName.special() + 'の空き情報を表示中</p>' + 
                        '<a href="map.html">' + settings.dataName.monthly() + 'の空き情報はこちら</a>';
                    return res;
                },
                
                // 月次データ表示中のアラートメッセージ
                monthly: function() {
                    var res = 
                        '<p>' + settings.dataName.monthly() + 'の空き情報を表示中</p>' + 
                        '<a href="map.html?target=1-2">' + settings.dataName.special() + 'の空き情報はこちら</a>'
                    return res;
                }
            }
        }

        // csv
        function Csv(is_nocache, name) {
            // version
            if (is_nocache) {
                this.version = "?version=" + dateFormat.format(new Date(), "yyyyMMddhhmmss");
            } else {
                this.version = "";
            }
            // name
            this.name = name + this.version;
            // data
            this._data = null;
        }
        Csv.prototype = {
            name: function() {return this.name;},
            data: function(data) {
                if (data) {
                    this._data = $.csv.toArrays(data);
                    // readCsvData();
                } else {
                    return this._data;
                }
            },
            text: function(row, col) {
                try {
                    function csv_cleansing_string(s) {
                        s = String(s);
                        s = s.replace(/\n/g, '');
                        s = s.replace(/'/g, '');
                        s = s.replace(/"/g, '');
                        s = s.replace(/</g, '');
                        s = s.replace(/>/g, '');
                        s = s.replace(/：/g, ':');
                        s = s.replace(/　/g, ' ');
                        s = s.replace(/（/g, '(');
                        s = s.replace(/）/g, ')');
                        s = s.replace(/－/g, '-');
                        s = s.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {return String.fromCharCode(s.charCodeAt(0) - 65248);});
                        return s;
                    }
                    return csv_cleansing_string(this.data()[row][col]);
                } catch(e) {
                    console.log(e);
                    return null;
                }
            },
            length: function() {
                return this.data().length;
            }
        }

        // csv data
        var csv_monthly = new Csv(true, "sukusukudata.csv");
        var csv_special = new Csv(true, "sukusukudata1-2.csv");

        // csv download
        function downloadCsvData() {
            function _downloadCsvData(csv, callback, failed) {
                if (!csv.data()) {
                    $.get(csv.name)
                    .done(function(data, status) { 
                        // success
                        csv.data(data);
                        if (callback) {callback(csv, status);}
                    })
                    .fail(function(status, status_text, description){
                        // fail
                        // console.log(csv.name);
                        if (failed) {failed(status, status_text, description);}
                    })
                    .always(function() {
                        // always
                    });
                }
            }
            _downloadCsvData(csv_monthly, function(){
                
                function _isSpecial() {
                    var target = getParam("target");
                    return (target == "1-2");
                }

                function showAlert(classname, message) {
                    var wrapper = $("#alert-wrapper");
                    if (wrapper) {
                        if (wrapper.length > 0) {
                            $(wrapper).removeClass();
                            $(wrapper).addClass(classname);
                            $("#alert-body").html(message);
                        }
                    }
                    $(".show-special-only.hidden").removeClass("hidden");
                }

                // succeed
                settings.baseDate.monthly = csv_monthly.text(1, 16);
                settings.targetMonth.monthly = csv_monthly.text(1, 20);
                _downloadCsvData(csv_special, function(){
                    
                    // succeed
                    settings.baseDate.special.startDate = csv_special.text(1, 16).split("-")[0];
                    settings.baseDate.special.endDate = csv_special.text(1, 16).split("-")[1];
                    settings.targetMonth.special = csv_special.text(1, 20);
                    $(".dataname-monthly").html(settings.dataName.monthly());
                    $(".dataname-special").html(settings.dataName.special());
                    
                    // show special data
                    function showSpecial() {
                        var classname = "uk-alert-warning";
                        var message = settings.alert.special();
                        showAlert(classname, message);
                        $("#target").val("1-2");
                        readCsvDataSpecial();
                    }
                    
                    // show monthly data
                    function showMonthly() {
                        var classname = "uk-alert-danger";
                        var message = settings.alert.monthly();
                        showAlert(classname, message);
                        $("#target").val("0");
                        readCsvDataMonthly();
                    }
                    
                    // show data
                    if (_isSpecial()) {
                        showSpecial();
                    } else {
                        showMonthly();
                    }

                    // change event
                    $("#target").change(function() {
                        
                        // close alert
                        var alert = $("#alert-wrapper");
                        if (alert) {
                            if (alert.length > 0) {
                                UIkit.alert($(alert)).close();
                            }
                        }
                        
                        // show data
                        if ($(this).val() == "1-2") {
                            showSpecial();
                        } else {
                            showMonthly();
                        }
                    });

                }, function(status, status_text, description){

                    // failed
                    if (_isSpecial()) {
                        showErrorDialog(
                            "現在、4月入所(2次調整)の空き情報の公開期間外です。<br>" +
                            "恐れ入りますが、期間中にアクセスをお願いいたします。<br>" +
                            '<a href="map.html">翌月入所の空き情報を確認したい場合はこちらをタップ</a>', 
                            "公開期間外"
                        );
                    } else {
                        readCsvDataMonthly();
                    }

                });

            }, function(status, status_text, description){

                // failed
                showErrorDialog(
                    "現在、データの準備中です。<br>" +
                    "恐れ入りますが、時間をおいてから再度アクセスをお願いいたします。", 
                    "準備中"
                );

            });
        }

        // csv read
        function readCsvDataMonthly() {
            
            // csvデータを画面に表示
            readCsvData(csv_monthly);
            
            // 説明画面の表示
            if (isExistsLiffSdk()) {
                var title = "保育施設等 空き情報マップ";
                var message = 
                    '<p>このコンテンツは、各区役所が公開している保育施設等の空き情報を基に作成した、モバイル向け検索ページです。</p>' +
                    '<ul class="uk-list uk-list-bullet">' +
                        '<li>この空き情報は、各区掲載時点での利用可能人数です。</li>' +
                        '<li>保育施設等を利用するためには、お住まいの区の保健福祉センターへ利用申込みを行い、利用調整を受ける必要があります。利用調整では、優先度の高い方から順に利用決定を行いますので、ご希望の保育施設等に空きがあっても、利用できない場合があります。</li>' +
                        '<li>年度途中の利用申込み期限は、希望月の前月5日までです。また、すでに申込み中であり、希望保育施設等を変更される場合も、希望月の前月5日までにお住まいの区の保健福祉センターへお申し出ください。</li>' +
                        '<li>クラス年齢は、当年度4月1日時点の満年齢です。</li>' +
                        '<li>詳しくはサンプル市ホームページをご覧ください。</li>' +
                    '</ul>' +
                    '<p>また、ご利用の環境によっては、動作が遅かったり、正しく動作しない場合がございます。あらかじめご了承下さい。</p>';
                showReadmeDialog(message, title);
            }
        }
        function readCsvDataSpecial() {
            
            // csvデータを画面に表示
            readCsvData(csv_special);
            
            // 説明画面の表示
            if (isExistsLiffSdk()) {
                var title = "保育施設等 空き情報マップ<br><strong>" + settings.dataName.special() + "</strong>";
                var message = 
                '<ul class="uk-list uk-list-bullet">' +
                        '<li>この2次調整の空き情報は、各区の' + dateFormat.format(new Date(settings.baseDate.special.startDate), "yyyy年M月dd日") + '現在での' + settings.targetMonth.special + '月からの利用可能人数です。(地図情報は、' + dateFormat.format(new Date(settings.baseDate.special.startDate), "M月dd日") + '現在の空き情報ですが、区ホームページの空き情報は時点修正されている場合がありますので、区ホームページの空き情報と必ずしも一致しない場合があります。)</li>' +
                        '<li>クラス年齢は、' + dateFormat.format(new Date(settings.baseDate.special.endDate), "yyyy年") + settings.targetMonth.special + '月1日現在での満年齢です。</li>' +
                        '<li>2次調整の受付期間は、' + dateFormat.format(new Date(settings.baseDate.special.endDate), "yyyy年M月dd日(ww曜日)") + 'までです。</li>' +
                        '<li>保育施設等の利用を希望される場合は、お住まいの区の保健福祉センター保育担当へお申し込みください。</li>' +
                        '<li>利用調整では、優先度の高い方からの順に利用決定を行いますので、ご希望の保育施設等に空きがあっても利用できない場合があります。</li>' +
                        '<li>詳しくはサンプル市ホームページをご覧ください。</li>' +
                    '</ul>' +
                    '<p>また、ご利用の環境によっては、動作が遅かったり、正しく動作しない場合がございます。あらかじめご了承下さい。</p>';
                showReadmeDialog(message, title);
            }
        }
        function readCsvData(csv) {
            removeMarkers(); // マーカーの削除
            createMarkers(csv); // マーカーの作成
        }

        // map
        var map;
        var map_center = {lat: 34.694062, lng: 135.502154};

        // circle
        var circle;

        // marker
        var markers = [];
        var currentMarker = null;

        // infowindow
        var rows = [];
        var infoWindows = [];
        var currentInfoWindow = null;

        // category
        var category_nintei = "認定こども園";
        var category_chiiki = "地域型";

        // GoogleMap コールバック関数 ( https://maps.googleapis.com/maps/api/js )
        function callbackGoogleMapApi() {

            // map
            var mapDiv = document.getElementById('map-canvas');
            var mapOptions = {
                center: map_center,
                zoom: 14,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(mapDiv, mapOptions);
            
            // circle
            drawCircle(map_center);

            // mapのイベント設定
            google.maps.event.addListener(map, 'click', function(event) {
                // フキダシを閉じる
                closeInfoWindow();
            });

            // circleのイベント設定
            google.maps.event.addListener(map, 'center_changed', function() {
                // 円を描画する
                drawCircle();
            })
        }

        // 円を描画する
        function drawCircle(center){
            
            // 初期化
            if (circle != null) {circle.setMap(null);}
            
            // centerの取得
            if (center == null) {
                var latlng = map.getCenter();
                center = new google.maps.LatLng(latlng.lat(), latlng.lng());
            }

            // radiusの取得
            var radius = parseInt($("#menu-query1").val());

            // circleのセット
            circle = new google.maps.Circle({
                center: center,
                radius: radius,
                strokeWeight: 4,
                strokeColor: "#0e6fd1",
                strokeOpacity: 0.6,
                fillColor: "#0e6fd1",
                fillOpacity: 0.1
            });
            circle.setMap(map);
        }

        // マーカーの一括削除
        function removeMarkers() {
            closeInfoWindow();
            if (markers.length != 0) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                markers = [];
                infoWindows = [];
                rows = [];
            }
        }
        
        // マーカーの一括作成
        function createMarkers(csv) {

            // マーカーの作成
            for (var i = 0; i < csv.length(); i++) {
                
                // レコードの取得
                var row = {
                    "position": {
                        "lat": parseFloat(csv.text(i, 0)),
                        "lng": parseFloat(csv.text(i, 1))
                    },
                    "name": csv.text(i, 2),
                    "address": csv.text(i, 4),
                    "tel": csv.text(i, 7),
                    "url": csv.text(i, 8),
                    "age": [
                        csv.text(i, 10),
                        csv.text(i, 11),
                        csv.text(i, 12),
                        csv.text(i, 13),
                        csv.text(i, 14),
                        csv.text(i, 15)
                    ],
                    "month": {
                        "now": csv.text(i, 16),
                        "target": csv.text(i, 20)
                    },
                    "category": csv.text(i, 9),
                    "designated": csv.text(i, 17)
                }
                rows[i] = row;

                // マーカーの作成
                var icon = getMarkerIcon(i);
                markers[i] = new google.maps.Marker({ 
                    position: {lat: rows[i].position.lat, lng: rows[i].position.lng},
                    map: map,
                    icon: icon
                });

                // フキダシの作成
                var infoWindowContent = getInfoWindowContent(i);
                infoWindows[i] = new google.maps.InfoWindow({content: infoWindowContent}); 
                infoWindows[i].addListener("closeclick", function(argument){
                    closeInfoWindow();
                });

                // マーカーのイベント設定
                addMarkerEvent(i);
            }
        }
        
        // マーカーのイベント設定
        function addMarkerEvent(i) {

            if (isSmartPhone()) {

                // スマートデバイスの場合

                // タップしたらフキダシを開く
                markers[i].addListener('click', function() { 
                    closeInfoWindow();
                    infoWindows[i].open(map, markers[i]); 
                    currentInfoWindow = infoWindows[i];
                });

            } else {

                // PCの場合

                // クリックしたらフキダシを開く
                markers[i].addListener('click', function() { 
                    closeInfoWindow();
                    infoWindows[i].open(map, markers[i]); 
                    currentInfoWindow = infoWindows[i];
                });

            }
        }

        // マーカーのアイコン設定
        function drawMarkers() {
            for (var i = 0; i < markers.length; i++) {drawMarker(i);}
        }
        function drawMarker(i) {
            var icon = getMarkerIcon(i);
            markers[i].setOptions({
                icon: icon
            });
        }
        function getMarkerIcon(i) {

            var icon = "img/{0}{1}.png"
            var row = rows[i];

            // カテゴリに応じたファイル名をセットする
            if (row.category == category_nintei) {
                icon = icon.replace("{0}", "b");
            } else if (row.category == category_chiiki) {
                icon = icon.replace("{0}", "c");
            } else {
                icon = icon.replace("{0}", "a");
            }
            
            // 空き有りであればtrueを返す
            function isEnabled(age) {

                // 引数を半角へ変換
                age = age.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                    return String.fromCharCode(s.charCodeAt(0) - 65248);
                });

                // 引数が数値でない場合
                var age_number = Number(age);
                if (isNaN(age_number)) {
                    var regexp = new RegExp(/^[0０\-ー―－×][\s|　]*$/);
                    if (age == "" || regexp.test(age)) {
                        
                        // ブランク : 受け入れ対象のクラスが無い
                        // ハイフン : 分園のため、本園で募集枠を記載
                        return false;

                    } else {
                        
                        // 上記以外 : 「調整中」「若干名」などを想定
                        return true;
                        
                    }
                }

                // 引数が数値かつ1以上であれば空き有り
                if (age_number > 0) {
                    return true;
                } else {
                    return false;
                }
            }

            // 空き状況に応じたファイル名を返す
            function getFileName(enabled) {
                if (enabled) {
                    return icon.replace("{1}", "-true");
                } else {
                    return icon.replace("{1}", "-false");
                }
            }

            // チェック状態を取得
            var chk = 0;
            $('input[name="menu-query2"]:checked').each(function() {
                chk += parseInt($(this).val());
            });

            // チェック状態に応じてファイル名を判定
            if (Number(String(chk).substr(-3)) != 0 && row.category == category_chiiki) {
                
                // 3歳以上いずれかがチェック有り かつ 地域型の場合、非活性
                icon = getFileName(false);

            } else if (chk == 0) {

                // チェック無しの場合、いずれかのクラス年齢に空きがあれば活性
                icon = getFileName(( 
                    isEnabled(row.age[0]) ||
                    isEnabled(row.age[1]) ||
                    isEnabled(row.age[2]) ||
                    isEnabled(row.age[3]) ||
                    isEnabled(row.age[4]) ||
                    isEnabled(row.age[5]) 
                ));

            } else {

                // チェック有りの場合、該当のクラス年齢全てに空きがあれば活性
                var chk_str = "000000" + String(chk);
                var chk_str_arr = chk_str.substr(-6).split("");
                var result = true;
                for (var i = 0; i < chk_str_arr.length; i++) {
                    var chk_int = Number(chk_str_arr[i]);
                    if (chk_int == 1) {
                        result = (result && isEnabled(row.age[i]));
                    }
                }
                icon = getFileName(result);
            }
            return icon;
        }

        // フキダシを閉じる
        function closeInfoWindow(i) {
            if (i == null || i == -1) {
                if (currentMarker) {currentMarker.setMap(null); currentMarker = null;}
                if (currentInfoWindow) {currentInfoWindow.close();}
            } else {
                infoWindows[i].close();
            }
        }

        // フキダシのhtmlソースを返す
        function getInfoWindowContent(i) {

            // 初期化
            var row = rows[i];
            
            // モバイル用
            var tel = row.tel;
            if (isSmartPhone()) {
                // 電話番号をリンク化
                tel = convertToAnchorTag(tel);
            }

            // tel, URL
            var infomation = "";
            if (tel != "") {
                var telStyle = "";
                if (row.url == "") {telStyle = ' style="width: 100%;"';}
                infomation += 
                    '<div class="tm-infowindow-content-body-part"' + telStyle + '>' +
                        '<p class="uk-margin-remove-bottom">' +
                            '<span uk-icon="icon: receiver; ratio: 0.8"></span>' + tel +
                        '</p>' +
                    '</div>';
            } else {
                infomation += '<div style="display: none;"></div>';
            }
            if (row.url != "") {
                var urlStyle = "";
                if (tel == "") {urlStyle = ' style="width: 100%;"';}
                infomation += 
                    '<div class="tm-infowindow-content-body-part"' + urlStyle + '>' +
                        '<p class="uk-margin-remove-bottom">' +
                            '<span uk-icon="icon: info; ratio: 0.8"></span>' + 
                            '<a href="' + row.url + '" target="_blank">施設情報 (.pdf)</a>' +
                        '</p>' +
                    '</div>';
            } else {
                infomation += '<div style="display: none;"></div>';
            }

            // 認定こども園の場合
            var discription1 = "";
            if (row.category == category_nintei) {discription1 = "・保育認定分";}

            // 指定園の場合
            var name = row.name;
            var description2 = "";
            if (row.designated == "1") {
                name = '<span class="uk-label uk-label-default">指定園</span>' + name;
                description2 = 
                    '<p class="uk-margin-small-top">' +
                        '※サンプル市要支援児受入促進指定園です。' +
                        '詳しくは、<a href="http://www.city.sample.lg.jp/?' + uriQueryOpenByBrowser + '" target="_blank">「サンプル市要支援児受入促進指定園」</a>をご覧ください。' +
                    '</p>';
            }

            // 時点の表示
            var discription3 = '空き状況 (' + row.month.now + '月1日現在/' + row.month.target + '月からの途中利用可能数';
            if ($(".show-special-only").eq(0).hasClass("hidden") == false) {
                if ($("#target").val() == "1-2") {
                    // 2次調整を表示中の場合
                    discription3 = settings.dataName.special() + "の空き情報 (" + dateFormat.format(new Date(settings.baseDate.special.startDate), "yyyy年M月dd日") + "現在";
                }
            }

            // content
            var content = 
                '<div class="uk-container tm-infowindow" id="infowindowcontent-' + i + '">' + 
                    '<div class="tm-infowindow-content-body">' +
                        '<h5 class="uk-h6 uk-margin-small-bottom">' + name + '</h5>' +
                        '<div class="tm-infowindow-content-body-part">' +
                            '<p class="uk-margin-remove-bottom">' +
                                '<span uk-icon="icon: location; ratio: 0.8"></span><a href="' + getUriForGoogleKeiro(row.address) + '" target="_blank">' + row.address + '</a>' +
                            '</p>' +
                        '</div>' +
                        infomation +
                        '<div class="uk-grid uk-padding-remove-bottom tm-infowindow-content-body-part">' +
                            '<p class="uk-text-meta">' +
                                discription3 + discription1 + ')' +
                            '</p>' +
                            '<div class="uk-width-1-2 tm-infowindow-content-body-grid">' +
                                '<p>0歳児: ' + row.age[0] + '</p>' +
                                '<p>1歳児: ' + row.age[1] + '</p>' +
                                '<p>2歳児: ' + row.age[2] + '</p>' +
                            '</div>' +
                            '<div class="uk-width-1-2 tm-infowindow-content-body-grid">' +
                                '<p>3歳児: ' + row.age[3] + '</p>' +
                                '<p>4歳児: ' + row.age[4] + '</p>' +
                                '<p>5歳児: ' + row.age[5] + '</p>' +
                            '</div>' +
                            description2 +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            return content;
        }

        // 現在地取得
        function getPOSfromGPS() {
            if(navigator.geolocation) {
            
                // Geolocation APIに対応している場合
                navigator.geolocation.getCurrentPosition(

                    // [第1引数] 取得に成功した場合の関数
                    function (position) {                        
                        var latitude  = position.coords.latitude; //緯度
                        var longitude = position.coords.longitude; //経度
                        var latlng = new google.maps.LatLng(latitude, longitude);

                        // 移動
                        map.panTo(latlng);
                    },
                    // [第2引数] 取得に失敗した場合の関数
                    function(error){
                        showErrorDialog(
                            "現在地の位置情報を取得できませんでした。<br>" + 
                            "ご利用の端末のGPS機能をONにして屋外でご利用ください。<br>" +
                            "端末によっては、現在位置を取得するまで時間がかかる場合があります。",
                            "位置情報取得エラー"
                        );
                    },
                    // [第3引数] オプション
                    {
                        "enableHighAccuracy": false,
                        "timeout": 8000,
                        "maximumAge": 2000,
                    }
                );
            } else {
                // Geolocation APIに対応していない場合
                showErrorDialog("ご利用の端末では、位置情報を取得できません。", "位置情報取得エラー");
            }
        }

        // エラーメッセージ表示
        function showErrorDialog(message, title) {
            if (message == null) {message = "　";}
            if (title == null) {title = "　";}
            $("#dialog-error-body").html('<p>' + message + '</p>');
            $("#dialog-error-title").html('<h2 class="uk-h5">' + title + '</h2>');
            UIkit.modal("#dialog-error").show();
        }

        // readme表示
        function showReadmeDialog(message, title) {
            if (message == null) {message = "　";}
            if (title == null) {title = "　";}
            $("#dialog-readme-body").html(message);
            $("#dialog-readme-title").html(title);
            UIkit.modal("#dialog-readme").show();
        }

        // ローディング表示
        function loadingStart() {
            $("#loader").removeAttr("hidden");
        }
        function loadingFinish() {
            $("#loader").attr("hidden", true);
        }

        // 電話番号リンクを付けて返す
        function convertToAnchorTag(str) {
            
            // 電話番号だと思われる文字列を抽出
            var phone_array = str.match( /\+?[0-9]+[\-\x20]?[0-9]+[\-\x20]?[0-9]+[\-\x20]?[0-9]+/g );
            var cursor = 0;
            for ( var i = 0; phone_array != null && i < phone_array.length; i++ ) {

                // ハイフンとスペースを削除
                var tmp = phone_array[i];
                tmp = tmp.replace( /[\-\x20]/g, '' );
                if ( tmp.length < 10 ) {
                    // 10桁未満は電話番号とみなさない
                    continue;
                }

                // aタグ文字列を生成
                var tag_a = '<a href="tel:' + tmp + '">' + phone_array[i] + '</a>';

                // 置換する電話番号の出現位置を取得
                var start = str.indexOf( phone_array[i], cursor );

                // 出現した電話番号を置換
                str = str.slice( 0, start ) + tag_a + str.slice( start + phone_array[i].length );
                cursor = start + tag_a.length;
            }

            return str;
        }

        // ロード後の初期化処理
        window.onload = function() {

            console.log("window.onload");

            // initialize this app
            function initializeThisApp() {
                
                // 距離メニューのイベント設定
                $("#menu-query1").change(function(){
                    drawCircle();
                });

                // クラス年齢メニューのイベント設定
                $('input[name="menu-query2"]').change(function(){
                    drawMarkers();
                });
                
                // csvデータの取得
                downloadCsvData();
            }

            // initialize LIFF
            if (isExistsLiffSdk()) {
                liff.init({
                    liffId: getLiffId()
                }).then(function() {
                    initializeThisApp();
                }).catch(function(err) {
                    showErrorDialog(err, "liff.init");
                });
            } else {
                initializeThisApp();
            }
        }

    </script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=(GoogleMapApiKey)"></script>
    
</body>
</html>
